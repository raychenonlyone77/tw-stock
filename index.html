<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å°è‚¡ 20 æ—¥ K ç·šèˆ‡çœŸæŒ¯å¹…ç›£æ§</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: #f1f5f9; padding: 20px; text-align: center; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; }
        h2 { color: #38bdf8; margin-bottom: 15px; }
        .loading { font-size: 18px; color: #38bdf8; font-weight: bold; margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #334155; }
        th { background: #334155; color: #94a3b8; }
        .trend-high { color: #f43f5e; font-weight: bold; }
        .trend-mid { color: #fbbf24; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸš€ å°è‚¡ 20 æ—¥ K ç·šèˆ‡çœŸæŒ¯å¹…ç›£æ§</h2>
        <p id="status" class="loading">ğŸ“¡ æ­£åœ¨åŒæ­¥ K ç·šæ•¸æ“š...</p>
        
        <div class="card"><div id="klineChart"></div></div>

        <div class="card">
            <table>
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>é–‹ / æ”¶</th>
                        <th>é«˜ / ä½</th>
                        <th>çœŸæŒ¯å¹… (é»)</th>
                        <th>çœŸæŒ¯å¹… %</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // æ‚¨çš„ CSV é€£çµ
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSQJGbsyoKWvG2hBanT7LaFGlBI4yC-ZsXR2y1L0ltN2T2U3HfCx2Pef2WM0IDKiw1hCcGItpkq-ZG3/pub?output=csv'; 

        async function fetchTradingData() {
            Papa.parse(csvUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        processData(results.data);
                    }
                }
            });
        }

        function processData(raw) {
            let chartData = [];
            let tableRecords = [];

            for (let i = 0; i < Math.min(21, raw.length - 1); i++) {
                let curr = raw[i];
                let prev = raw[i + 1];

                // æŠ“å–äº”å€‹é—œéµæ¬„ä½
                let o = parseFloat(curr.Open || curr.open);
                let h = parseFloat(curr.High || curr.high);
                let l = parseFloat(curr.Low || curr.low);
                let c = parseFloat(curr.Close || curr.close);
                let pc = parseFloat(prev.Close || prev.close);
                let dateStr = curr.Date || curr.date || "";

                if (isNaN(o) || isNaN(h) || isNaN(l) || isNaN(c) || isNaN(pc)) continue;

                // æº–å‚™ K ç·šåœ–æ ¼å¼
                chartData.push({
                    x: dateStr.split(' ')[0],
                    y: [o, h, l, c] // é †åºå¿…é ˆæ˜¯: é–‹, é«˜, ä½, æ”¶
                });

                // è¨ˆç®—çœŸæŒ¯å¹…
                let tr = Math.max(h, pc) - Math.min(l, pc);
                let trPercent = ((tr / pc) * 100).toFixed(2);

                tableRecords.push({ date: dateStr.split(' ')[0], o, c, h, l, tr, trPercent });
            }

            renderChart(chartData.reverse());
            renderTable(tableRecords);
            document.getElementById('status').style.display = 'none';
        }

        function renderChart(data) {
            const options = {
                series: [{ data: data }],
                chart: { type: 'candlestick', height: 350, toolbar: { show: false }, background: '#1e293b' },
                theme: { mode: 'dark' },
                xaxis: { type: 'category', labels: { style: { colors: '#94a3b8' } } },
                yaxis: { tooltip: { enabled: true }, labels: { style: { colors: '#94a3b8' } } },
                plotOptions: {
                    candlestick: {
                        colors: { upward: '#f43f5e', downward: '#10b981' }, // ç´…æ¼²ç¶ è·Œ (å°è‚¡ç¿’æ…£)
                        wick: { useFillColor: true }
                    }
                }
            };
            const chart = new ApexCharts(document.querySelector("#klineChart"), options);
            chart.render();
        }

        function renderTable(data) {
            const body = document.getElementById('tableBody');
            data.forEach(d => {
                let colorClass = d.trPercent >= 1.5 ? 'trend-high' : (d.trPercent >= 0.8 ? 'trend-mid' : '');
                body.innerHTML += `<tr>
                    <td>${d.date}</td>
                    <td>${d.o.toFixed(0)} / ${d.c.toFixed(0)}</td>
                    <td>${d.h.toFixed(0)} / ${d.l.toFixed(0)}</td>
                    <td>${Math.round(d.tr)}</td>
                    <td class="${colorClass}">${d.trPercent}%</td>
                </tr>`;
            });
        }

        fetchTradingData();
    </script>
</body>
</html>


